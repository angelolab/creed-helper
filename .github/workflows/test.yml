name: Test

on:
  workflow_call:

permissions:
  contents: read # to fetch code (actions/checkout)

jobs:
  test:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os}}
    strategy:
      # Ensure that a wheel builder finishes even if another fails
      fail-fast: false
      matrix:
        python-version: [3.x] # latest stable release
        poetry-version: [latest]
        os: [ubuntu-latest, macos-latest, windows-latest]
    defaults:
      run:
        shell: bash


    steps:
      - name: Checkout ${{ github.repository }}
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Set up Python ${{matrix.python-version}}
        uses: actions/setup-python@v4
        id: setup-python
        with:
          python-version: ${{matrix.python-version}}
          check-latest: true
          cache: "poetry"

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{matrix.poetry-version}}
          virtualenvs-create: true
          virtualenvs-in-project: true
          installer-parallel: true

      - name: Load Cached Virtual Environment
        id: cached-pip-wheels
        uses: actions/cache@v3
        with:
          path: ~/.cache
          key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Set up Poetry Dynamic Versioning
        run: |
          poetry self add "poetry-dynamic-versioning[plugin]"

      - name: Linting, Typechecking and Formatting
        uses: pre-commit/action@v3.0.0

      - name: Install Dependencies
        run: poetry install --no-interaction --no-root

      - name: Install ${{ github.repository }}
        run: |
          poetry install --no-interaction

      - name: Run Tests
        run: |
          source $VENV
          poetry install --with test --no-interaction --no-root
          poetry run pytest

      - name: Archive Coverage
        uses: actions/upload-artifact@v3
        with:
          name: coverage-${{join(matrix.*, '-')}}
          path: |
            coverage.lcov
